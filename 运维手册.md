# 学校心理监测系统运维手册

## 系统架构

- **后端**: FastAPI + SQLAlchemy + MySQL
- **前端**: Vue 3 + Element Plus
- **数据库**: MySQL 8.0
- **部署**: Docker + Docker Compose

## 部署指南

### 1. 环境准备

#### 系统要求
- Linux/Windows/macOS
- Python 3.11+
- Node.js 18+
- MySQL 8.0+
- Docker & Docker Compose (可选)

#### 依赖安装
```bash
# Python依赖
cd psy_admin_fastapi
pip install -r requirements.txt

# Node.js依赖
cd psy_admin_vue
npm install
```

### 2. 配置设置

#### 后端配置
1. 复制环境变量文件：
```bash
cp psy_admin_fastapi/env.example psy_admin_fastapi/.env
```

2. 编辑 `.env` 文件，配置数据库连接等信息：
```env
SECRET_KEY=your-secret-key-here
DATABASE_URL_NO_DB=mysql+pymysql://root:password@localhost:3306/
DB_NAME=psy_test_db
ALLOWED_ORIGINS=http://localhost:8080,http://127.0.0.1:8080
```

#### 前端配置
1. 复制环境变量文件：
```bash
cp psy_admin_vue/env.development psy_admin_vue/.env.development
cp psy_admin_vue/env.production psy_admin_vue/.env.production
```

2. 编辑环境变量文件，配置API地址：
```env
VUE_APP_API_BASE=http://localhost:8000
```

### 3. 数据库初始化

#### 创建数据库
```sql
CREATE DATABASE psy_test_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 运行迁移
```bash
cd psy_admin_fastapi
python3 migrate.py upgrade
```

#### 初始化管理员账户
```bash
python3 init_admin.py
```

### 4. 启动服务

#### 开发模式
```bash
# 启动后端
cd psy_admin_fastapi
python3 -m uvicorn main:app --host 0.0.0.0 --port 8000

# 启动前端
cd psy_admin_vue
npm run serve
```

#### 生产模式
```bash
# 使用Docker Compose
docker-compose up -d

# 或使用部署脚本
chmod +x deploy.sh
./deploy.sh
```

## 运维操作

### 1. 数据库管理

#### 备份数据库
```bash
mysqldump -u root -p psy_test_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 恢复数据库
```bash
mysql -u root -p psy_test_db < backup_file.sql
```

#### 数据修复
```bash
cd psy_admin_fastapi
python3 data_repair_script.py
```

### 2. 日志管理

#### 查看应用日志
```bash
# 后端日志
tail -f psy_admin_fastapi/app.log

# Docker日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

#### 日志轮转
```bash
# 配置logrotate
sudo vim /etc/logrotate.d/psy-admin
```

### 3. 性能监控

#### 数据库性能
```sql
-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看连接数
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';
```

#### 应用性能
```bash
# 查看进程状态
ps aux | grep python
ps aux | grep node

# 查看端口占用
netstat -tlnp | grep :8000
netstat -tlnp | grep :8080
```

### 4. 安全维护

#### 定期更新
```bash
# 更新Python依赖
pip install --upgrade -r requirements.txt

# 更新Node.js依赖
npm update

# 更新Docker镜像
docker-compose pull
docker-compose up -d
```

#### 安全检查
```bash
# 检查开放端口
nmap -sT -O localhost

# 检查SSL证书（如果使用HTTPS）
openssl s_client -connect your-domain.com:443
```

## 故障排除

### 1. 常见问题

#### 数据库连接失败
- 检查MySQL服务是否启动
- 验证数据库连接配置
- 检查防火墙设置

#### 前端无法访问后端
- 检查CORS配置
- 验证API地址配置
- 检查网络连接

#### 文件上传失败
- 检查文件大小限制
- 验证存储目录权限
- 检查磁盘空间

### 2. 错误日志分析

#### 后端错误
```bash
# 查看详细错误信息
grep -i error psy_admin_fastapi/app.log
grep -i exception psy_admin_fastapi/app.log
```

#### 前端错误
- 打开浏览器开发者工具
- 查看Console和Network标签
- 检查API响应状态

### 3. 性能优化

#### 数据库优化
- 添加适当的索引
- 优化查询语句
- 调整连接池参数

#### 应用优化
- 启用缓存
- 优化静态资源
- 使用CDN加速

## 备份策略

### 1. 数据备份
- 每日全量备份
- 实时binlog备份
- 定期测试恢复

### 2. 代码备份
- 使用Git版本控制
- 定期推送到远程仓库
- 保留发布版本标签

### 3. 配置文件备份
- 备份环境变量文件
- 备份数据库配置
- 备份Nginx配置

## 监控告警

### 1. 系统监控
- CPU使用率
- 内存使用率
- 磁盘空间
- 网络流量

### 2. 应用监控
- 响应时间
- 错误率
- 并发用户数
- 数据库连接数

### 3. 告警设置
- 设置阈值告警
- 配置通知方式
- 建立值班制度

## 联系信息

- 技术支持: [技术支持邮箱]
- 紧急联系: [紧急联系电话]
- 文档更新: [文档维护人员]

---

*最后更新: 2025-09-20*

