# 学校心理监测系统 标准化改造方案

版本: v1.0  日期: 2025-09-19  负责人: （填写）

## 目标
- 提升稳定性、可维护性与可扩展性，支持学校长期运行与多人协作。
- 以标准化迁移、配置化、安全加固与性能优化为核心，确保上线与后续迭代可控。

## 一、数据库与数据层
1) 迁移与结构一致性（Alembic）
- 引入 Alembic 管理迁移脚本，版本化所有表结构变更。
- 首批迁移内容：
  - `tests.student_fk_id` 外键（指向 `students.id`），并创建索引。
  - 为 `tests(test_time)`, `tests(status)`, `scores(test_fk_id)`, `physiological_data(test_fk_id)` 建索引。
  - （可选）唯一约束：`UNIQUE(student_fk_id, test_time)` 或新增 `record_uuid` 唯一键，保障客户端上传幂等。
- 提供数据修复脚本：
  - 扫描孤儿记录与重复记录，输出修复 SQL 或自动处理。

2) 会话与并发规范
- 子线程/任务内必须自行 `SessionLocal()` 获取与关闭，禁止跨线程共享 Session。
- 连接池参数与 MySQL 最大连接数匹配（建议 pool_size 10~20，pool_recycle 1800）。

3) 数据访问性能
- 列表/仪表盘查询采用预加载（joinedload）避免 N+1。
- 统计改聚合 SQL + 60~120s 缓存，移除 `limit=999999` 全表扫描。

## 二、配置与安全
1) 环境配置
- `.env` 管理 `SECRET_KEY`、`DATABASE_URL_NO_DB`、`DB_NAME`、`ALLOWED_ORIGINS`、`REPORT_DIR`。
- 区分 `dev` 与 `prod`，默认禁止把密钥写入代码。

2) 安全加固
- CORS 白名单仅允许学校前端域名；仅暴露必要方法/头。
- Token 过期 30 分钟；前端捕获 401 自动登出；（可选）加入 refresh token。
- 审计日志：登录、批量导入、报告下载均记录管理员、IP、时间、UA。

## 三、接口与业务流程
1) Excel 批量导入
- 列校验（name/student_id/class_name/gender），缺失列与错误行汇总返回。
- 去重策略：导入前批量查询现存学号集合；并发下依赖唯一约束捕获冲突，返回冲突清单。
- 结果回执：成功数/重复数/失败列表；提供错误行 Excel 下载。

2) 客户端联动
- 学号校验接口：`POST /api/client/validate-student`，缓存 120s。
- 数据上传接口：`POST /api/client/upload-test-data`（multipart: `pdf_file` + `test_data` JSON）。
- 幂等键：`(student_id, test_time)` 或 `record_uuid`，避免重复写入。
- 文件保存：绝对路径 `reports/{yyyy-mm-dd}/{safe_name}_{student_id}.pdf`，超限文件拒绝（默认 10MB）。

3) 状态与报告
- 记录状态 not_started/in_progress/completed/failed，与“正常/异常/未开始”筛选的映射稳定化。
- 报告预览从数据库生成文本；若客户端上传了 PDF，则直接提供原 PDF 下载；下载写审计。

## 四、前端标准化
1) 环境与路由
- 使用环境变量 `VUE_APP_API_BASE` 控制 API baseURL（dev/prod 分离）。
- 路由：
  - 检测记录 `/test-records`（列表/筛选/分页/视图切换）。
  - 报告管理 `/reports`（输入学号跳转 `/reports/:student_id` 预览/下载）。
- 守卫：解析 JWT `exp`，过期本地登出，避免闪烁。

2) 体验与一致性
- 全局错误提示统一；接口封装统一处理 401、网络异常与业务错误。
- 组件按需加载与代码分割，提升首屏速度。

## 五、运维与可观测性
1) 日志与追踪
- 统一结构化日志（JSON 可选），关键链路（导入、上传、导出、下载）记录耗时与结果。

2) 备份与恢复
- MySQL 每日全量 + binlog；`reports/exports` 目录纳入备份策略。

3) 部署规范
- 后端以包导入方式适配任意工作目录启动；或文档明确在 `psy_admin_fastapi` 目录启动。
- 提供 `docker-compose`（可选）：mysql + backend + nginx(frontend)。

## 六、交付与验收
- 提供演示数据脚本（1000 学生、2000 记录）。
- 验收清单覆盖：导入、学号校验、上传、列表/状态、报告预览/下载、导出、仪表盘。
- 性能目标（单机）：
  - 统计接口 P95 < 500ms（缓存开启）。
  - 上传并发 50 时稳定无错误；队列堆积可控。

## 七、实施计划（建议 5 天）
Day 1：引入 Alembic，首批迁移（tests 外键/索引）、数据修复脚本；统一会话规范。
Day 2：配置环境化与 CORS；接口幂等与上传限制；报告路径改绝对路径+分目录。
Day 3：仪表盘聚合+缓存；列表索引与预加载；导入去重与错误回执。
Day 4：前端环境变量/守卫过期；页面交互完善；统一错误提示。
Day 5：压测与演练；备份策略与运维手册；验收用例对照签收。

## 八、风险与回滚
- 迁移失败：可回滚到上一版本；先在测试库验证再上生产。
- 配置不当：启用 `.env` 样例并校验启动前变量完整性。
- 并发峰值：必要时降级策略（关闭部分统计、延后导出）。

## 九、文档与培训
- 管理员指南：导入、过滤、报告下载、常见错误处理。
- 开发规范：数据库迁移流程、会话/线程规范、日志约定、前端环境配置。

（完）


